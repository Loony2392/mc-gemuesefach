name: ğŸ› ï¸ Test Minecraft Server with Mods

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test-minecraft-server:
    runs-on: ubuntu-latest

    steps:
      # ğŸ“‚ Repository auschecken
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v3

      # â˜• Java 21 installieren
      - name: â˜• Set up Java 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21' # Minecraft benÃ¶tigt Java 21

      # ğŸ“‚ Kopiere Mods aus dem Repository (ohne redundantes Kopieren)
      - name: ğŸ“‚ Copy Mods from Repository
        run: |
          mkdir -p mods
          find ./mods -type f -name "*.jar" -exec cp {} ./mods/ \;

      # â¬‡ï¸ Mods aus mods.txt herunterladen
      - name: â¬‡ï¸ Download Mods from mods.txt
        run: |
          mkdir -p mods
          while IFS= read -r slug; do
            if [ ! -z "$slug" ]; then
              echo "Downloading mod: $slug"
              curl -s "https://api.modrinth.com/v2/project/$slug/version" | jq -r '.[0].files[0].url' | xargs -n 1 curl -O -J
              mv *.jar mods/
            fi
          done < mods.txt

      # â¬‡ï¸ Download Fabric Server Launcher
      - name: â¬‡ï¸ Download Fabric Server Launcher
        run: |
          curl -OJ https://meta.fabricmc.net/v2/versions/loader/1.21.4/0.16.12/1.0.3/server/jar
          mv fabric-server-mc.1.21.4-loader.0.16.12-launcher.1.0.3.jar server.jar

      # âœ… Accept Minecraft EULA
      - name: âœ… Accept Minecraft EULA
        run: echo "eula=true" > eula.txt

      # ğŸš€ Server starten
      - name: ğŸš€ Start Minecraft Server
        run: |
          java -Xmx2G -jar server.jar nogui &
          sleep 30 # Warte, bis der Server vollstÃ¤ndig gestartet ist

      # âœ… ÃœberprÃ¼fen, ob der Server lÃ¤uft
      - name: âœ… Check Server Status
        run: |
          if pgrep -f "server.jar" > /dev/null; then
            echo "âœ… Server is running successfully!"
          else
            echo "âŒ Server failed to start."
            exit 1
          fi