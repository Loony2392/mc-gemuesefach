name: ğŸ› ï¸ Test Minecraft Server Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test-minecraft-server:
    runs-on: ubuntu-latest

    steps:
      # ğŸ“‚ Repository auschecken
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v3

      # ğŸ³ Docker installieren
      - name: ğŸ³ Set up Docker
        uses: docker/setup-buildx-action@v2

      # ğŸ³ Docker Compose installieren
      - name: ğŸ³ Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      # ğŸ“‚ Mods-Ordner vorbereiten
      - name: ğŸ“‚ Prepare Mods Folder
        run: |
          mkdir -p /opt/minecraft/server/mods
          cp -r mods/* /opt/minecraft/server/mods/

      # ğŸš€ Docker-Compose starten
      - name: ğŸš€ Start Minecraft Server with Docker Compose
        run: |
          docker-compose -f docker/docker-compose.yaml up -d

      # â³ Warten, bis der Server vollstÃ¤ndig gestartet ist
      - name: â³ Wait for Server to Start
        run: |
          echo "Waiting for server to start..."
          sleep 300  # 5 Minuten warten
          echo "âœ… Finished waiting for server startup."

      # ğŸ“œ Server-Logs auf Fehler Ã¼berprÃ¼fen
      - name: ğŸ“œ Check Server Logs for Errors
        run: |
          echo "Checking server logs for errors..."
          docker logs mc_gemuesefach | tee server.log
          if grep -i "\[.*\/ERROR\]" server.log; then
            echo "âŒ Errors found in server logs!"
            exit 1
          else
            echo "âœ… No errors found in server logs."
          fi

      # âœ… ÃœberprÃ¼fen, ob der Server lÃ¤uft
      - name: âœ… Check Server Status
        run: |
          if docker ps | grep mc_gemuesefach > /dev/null; then
            echo "âœ… Server is running successfully!"
          else
            echo "âŒ Server failed to start."
            exit 1
          fi

      # ğŸ›‘ Docker-Compose stoppen
      - name: ğŸ›‘ Stop Docker Compose
        if: always()
        run: |
          docker-compose -f docker/docker-compose.yaml down